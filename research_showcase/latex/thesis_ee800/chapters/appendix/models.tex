\chapter{Models: Battery Model for Multi-Period OPF}

All subscripts $j$ for a variable imply the node in the power grid (for node $j$).
All superscripts $t$ refer to the time period number $t$.

\begin{table}[htbp]
	\label{tab:grid_Nazir2018Jun}
	\centering
	\caption{Description of Grid Parameters}
	\begin{tabular}{>{\raggedright\arraybackslash $}p{2.5cm}<{$}
		>{\raggedright\arraybackslash}p{7.5cm}}
		\toprule
		\text{Variable} & \text{Description}                                                   \\
		\midrule
		\mathcal{N}     & {Set of all nodes. $\mathcal{N} = \{1,2, \ldots n\}$}                \\
		\mathcal{L}     & {Set of all branches. $\mathcal{L} =
		\{1,2, \ldots l\} = \{(i, k)\} \subset (\mathcal{N} \times \mathcal{N})$.}             \\
		\mathcal{D}     & {Set of all nodes containing DERs. $\mathcal{D}
		\subset \mathcal{N}$}                                                                  \\
		\mathcal{B}     & {Set of all nodes containing storage. $\mathcal{B}
		\subset \mathcal{N}$}                                                                  \\
		{\Delta t}      & {Duration of a single time period. Here $\Delta t = 15
		\text{ min.} = 0.25 \text{ h}$.}                                                       \\
		T               & {Prediction Horizon Duration. Total time duration solved for as part
		of one instance of MP-OPF.}                                                            \\
		K               & {Prediction Horizon Number. Total number of discrete-time steps
		solved for in one instance of MP-OPF. $T = K \Delta t$}                                \\
		\bottomrule
	\end{tabular}%
\end{table}%

\begin{table}[htbp]
	\label{tab:bfm_variables}
	\centering
	\caption{Description of Branch Flow Model Variables}
	\begin{tabular}{>{\raggedright\arraybackslash $}p{2.5cm}<{$}
		>{\raggedright\arraybackslash}p{7.5cm}}
		\toprule
		\text{Variable} & \text{Description}                                                   \\
		\midrule
		{p_j^t}     & {Fixed Real Power Generation minus Fixed Real Power Load.
		Here, $p_j^t = p_D{_j}^t - p_L{_j}^t$. A known (predicted) value $\forall \, t, j$.}                \\
		{q_j^t}     & {Fixed Reactive Power Generation minus Fixed Reactive Power Load.
		Here, $q_j^t = - q_L{_j}^t$. A known (predicted) value $\forall \, t, j$.} \\
		{p_{D_j}^t} & {Real Power Generated by DERs} \\
		{p_{L_j}^t} & {Real Power Demand} \\
		{q_{L_j}^t} & {Reactive Power Demand} \\
		\bottomrule
	\end{tabular}%
\end{table}%

In \cite{Nazir2018Jun, Nazir2019Jun}, the batteries are modelled using
four state/control variables, which are:
\begin{table}[htbp]
	\label{tab:batt_Nazir2018Jun}
	\centering
	\caption{Description of Battery Variables}
	\begin{tabular}{>{\raggedright\arraybackslash $}p{2.5cm}<{$}
			>{\raggedright\arraybackslash}p{5cm}
			>{\centering\arraybackslash $}p{2.5cm}<{$}
		>{\centering\arraybackslash\arraybackslash $}p{2.5cm}<{$}}
			\toprule
		\text{Variable}                           & \text{Description}                                  & \text{Dimension} &
		\text{Dimension $pu$}                                                                                                        \\
			\midrule
		B_{n, k}                                  & State of Charge (SOC) of Battery                    & [kWh]            & [pu\,h] \\
		P^c_{n, k}                                & Average Charging Power of the Battery during the
		$k$-th time interval.                     & [kW]                                                & [pu]                       \\
		P^d_{n, k}                                & Average Discharging Power of the Battery during the
		$k$-th time interval.                     & [kW]                                                & [pu]                       \\
		q_{B_{n, k}}                              & Average Reactive Power Output from the Battery
		Inverter during the $k$-th time interval. & [kVAr]                                              & [pu]                       \\
		\bottomrule
	\end{tabular}%
\end{table}%

\clearpage
\text{where, }
\begin{description}
	\item[$k \in \{0, 1, 2, \ldots, T/\Delta t\}$] The index of the discretized time intervals, where $k$ represents
		the $k$-th time interval of duration $\Delta t$ within the continuous time range
		$[0, T]$. The corresponding continuous time interval is $[(k-1)\Delta t, k\Delta t]$.
	\item[$n \in \mathcal{N}$] The node $n$ is an element of the set of all nodes
		in the power grid $\mathcal{N}$. Note that $n$ can be used both as an iterator or
		as the total number of nodes in the grid (i.e. the cardinality of $\mathcal{N}$),
		and its meaning should be obvious from context.
		% Add more items as needed
\end{description}

\begin{table}[htbp]
	\label{tab:bounds_batt_Nazir2018Jun}
	\centering
	\caption{Values, Lower Bounds and Upper Bounds on Battery Variables}
	\begin{tabular}{>{\raggedright\arraybackslash $}p{2.5cm}<{$}
			>{\raggedright\arraybackslash $}p{5.5cm}<{$}
		>{\raggedright\arraybackslash}p{4.5cm}<{}}
		\toprule
		\text{Variable}   & \text{Value or Limits}                        & \text{Description}                    \\
		\midrule
		{P_{Max}}         & {P_{Rated} \text{ of corresponding DER.}}     & {}                                    \\
		{q_{B_{Max}}}     & {q_{D_{Rated}} \text{ of corresponding DER.}} & {}                                    \\
		{P_d, P_c}        & {[0, P_{Max}]}                                & {}                                    \\
		{E_{Rated}}       & {P_{Max} \times 4\text{ h}}                   & {$4 \text{ h}$ of
		one-way Charging/Discharging at Maximum Power}                                                            \\
		{B}               & {[0.30E_{Rated}, 0.95E_{Rated}]}              & {$2.4 \text{ h}$ of
		one-way Charging/Discharging at Maximum Power}                                                            \\
		{B_0}             & {0.625E_{Rated}}                              & {Batteries start with an SOC value in
		the middle of their SOC range.}                                                                           \\
		{\eta_d , \eta_c} & {0.95}                                         & {}                                    \\
		{\alpha} & {3\mathrm{e}{-5}} & {Value depends on the magnitude 
		of the loss term in the objective function (for IEEE 123 node system, 
		it is $\approx (1\mathrm{e}{-5}, 10\mathrm{e}{-5}))$. Too big a value of 
		$\alpha$ would reduce both $P_c$ and $P_d$ terms to zero, whereas
		too small a value would not penalize SCD, causing physically infeasible 
		solutions.} \\
		\bottomrule
	\end{tabular}%
\end{table}%
% 

\section*{Optimization Equations}

\subsection*{Step 2: Full Optimization Model - Single Time Step Greedy Approach}


\begin{gather}
    \min_{P_{ij}^t, Q_{ij}^t, v_{j}^t, l_{ij}^t, q_{D_j}^t, B_{j}^{t+1},
	P_{c_j}^t, P_d{_j}^t, q_{B_j}^t} \quad
	\sum_{\fromto{i, j} \in \mathcal{L}} (r_{ij}l_{ij}^t) + 
	\alpha \sum_{j \in \mathcal{B}} \left\{ (1- \eta_c)P_{c_j}^t + \left(\frac{1}{\eta_d}-1\right) P_{d_j}^t \right\} \\
	\begin{align}
		\text{s.t.} & {}\nonumber \\
		{p_j^t} & = {\sum_{\fromto{j,k} \in \mathcal{L}} P_{jk}^t - \sum_{\fromto{i,j} \in \mathcal{L}}\left\{P_{ij}^t - r_{ij}l_{ij}^t\right\} + P_{d_j}^t - P_{c_j}^t} && \\
		{q_j^t} & = {\sum_{\fromto{j,k} \in \mathcal{L}} Q_{jk}^t - \sum_{\fromto{i,j} \in \mathcal{L}}\left\{Q_{ij}^t - x_{ij}l_{ij}^t\right\} + q_{D_j}^t + q_{B_j}^t} && \\
		{v_j^t} & = {v_{i}^t +  \left\{(r_{ij}^{t})^2 + (x_{ij}^{t})^2\right\}l_{ij}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t)} && \\
		{l_{ij}^t} & = {\frac{(P_{ij}^{t})^2 + (Q_{ij}^{t})^2}{v_j^t}} \\
		{B_{j}^{t+1}} &= {B_{j}^{t} - \Delta t  \eta_c P_{c_j}^t + \Delta t\frac{1}{\eta_d} P_{d_j}^t} \\
		{where,} & {} \\
		{p_j^t} &= {p_D{_j}^t - p_L{_j}^t} \\
		{q_j^t} &= {-q_L{_j}^t}
	\end{align}
\end{gather}

\subsection*{Step 1b: Initialisation Lossless Optimization Model WITH Batteries - Single Time Step Greedy Approach}


\begin{gather}
    \min_{P_{ij}^t, Q_{ij}^t, q_{D_j}^t, B_{j}^{t+1},
	P_{c_j}^t, P_d{_j}^t, q_{B_j}^t} \quad
	\sum_{\fromto{i, j} \in \mathcal{L}} \left\{r_{ij}\frac{(P_{ij}^{t})^2 + (Q_{ij}^{t})^2}{v_{0j}^{t}} \right\} + 
	\alpha \sum_{j \in \mathcal{B}} \left\{(1- \eta_c)P_{c_j}^t + \left( \frac{1}{\eta_d}-1 \right) P_{d_j}^t \right\} \\
	\begin{align}
		\text{s.t.} & {}\nonumber \\
		{p_j^t} & = {\sum_{\fromto{j,k} \in \mathcal{L}} P_{jk}^t - \sum_{\fromto{i,j} \in \mathcal{L}}\left(P_{ij}^t\right) + P_{d_j}^t - P_{c_j}^t} && \\
		{q_j^t} & = {\sum_{\fromto{j,k} \in \mathcal{L}} Q_{jk}^t - \sum_{\fromto{i,j} \in \mathcal{L}}\left(Q_{ij}^t\right) + q_{D_j}^t + q_{B_j}^t} && \\
		{v_{0j}^t} & = {v_{0i}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t)} && \\
		{B_{j}^{t+1}} &= {B_{j}^{t} - \Delta t  \eta_c P_{c_j}^t + \Delta t\frac{1}{\eta_d} P_{d_j}^t} \\
		{where,} & {} \\
		{p_j^t} &= {p_D{_j}^t - p_L{_j}^t} \\
		{q_j^t} &= {-q_L{_j}^t}
	\end{align}
\end{gather}

\subsection*{Step 1a: Initialisation Lossless Optimization Model WITHOUT Batteries - Single Time Step Greedy Approach}


\begin{gather}
    \min_{P_{ij}^t, Q_{ij}^t, v_{j}^t,  q_{D_j}^t} \quad 0 \\
	\begin{align}
		\text{s.t.} & {}\nonumber \\
		{p_j^t} & = {\sum_{\fromto{j,k} \in \mathcal{L}} P_{jk}^t - \sum_{\fromto{i,j} \in \mathcal{L}} P_{ij}^t } && \\
		{q_j^t} & = {\sum_{\fromto{j,k} \in \mathcal{L}} Q_{jk}^t - \sum_{\fromto{i,j} \in \mathcal{L}} Q_{ij}^t } && \\
		{v_j^t} & = {v_{i}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t)} && \\
		{where,} & {} \\
		{p_j^t} &= {p_D{_j}^t - p_L{_j}^t} \\
		{q_j^t} &= {-q_L{_j}^t}
	\end{align}
\end{gather}

A simple metric called $P_{Save}$ gives an indication of the effect of power
generated by batteries and DERs which offset substation power 
(indirectly flowing it via its parent area if it is not directly connected to 
the substation).

Its formula is as shown:

\begin{align}
	{P_{Save}} &= {100\% * \left(\frac{\sum_{j \in \mathcal{B}}\left( P_{d_j} - P_{c_j} \right)}{P_{12} + 
	\sum_{j \in \mathcal{D}} P_{DER_j} +  \sum_{j \in \mathcal{B}}\left( P_{d_j} - P_{c_j} \right)} \right)}
\end{align}
